<!DOCTYPE html>
<html>
    <head>
        <link rel="icon" type="image/x-icon" href="./favicon.ico"> 
        <title>Mandelbrot Set</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <script id = "shader-vs" type="x-shader/x-vertex">
            attribute vec3 position;
            void main() {
                gl_Position = vec4(position, 1.0);
            }
        </script>

        <script id = "shader-fs" type = "x-shader/x-fragment">
            precision highp float;
            uniform float zoom;
            uniform vec2 offset;
            varying vec3 pos;
            
            void main() {
                vec2 z = vec2(0,0);
                vec2 c = zoom*gl_FragCoord.xy/vec2(800, 800)+offset;
                int iter;
                for(int i = 0; i <= 200; i++)
                {
                    vec2 tz = z;
                    tz.x = z.x * z.x - z.y * z.y + c.x;
                    tz.y = 2.0 * z.x * z.y + c.y;
                    z.x = tz.x;
                    z.y = tz.y;
                    iter = i;
                    if(z.x * z.x + z.y * z.y > 4.0)
                        break;
                }
                float f = float(iter)/50.0;
                if(iter == 200)
                    gl_FragColor = vec4(0, 0, 0, 1);
                else
                    gl_FragColor = vec4(f, f, f, 1);
                    gl_FragColor = vec4(1.0,1.0,1.0,1.0);
            }
        </script>
        <script src = "Lib.js"></script>
        <script>
            var program;
            var gl;
            var zoom = 2;
            var offset = new Vector2f(-1.5,-1);
            var canvas;
            function webGLStart() {
                canvas = document.getElementById('canvas');
				canvas.addEventListener("mousemove", function(event){
					var mousePos = getMousePos(canvas, event);
					var x = mousePos.x/400-1.5;
					var y = 2*(mousePos.y/400-1);
					document.getElementById('coords').innerHTML = "X: " + x + ", Y: " + y;
				}, false);
                gl = canvas.getContext('webgl');
                gl.enable(gl.DEPTH_TEST);
                gl.clearColor(1, 0, 1, 1);
                
                var vertexShader = gl.createShader(gl.VERTEX_SHADER);
                gl.shaderSource(vertexShader, document.getElementById("shader-vs").textContent);
                gl.compileShader(vertexShader);

                var fragmentShader = gl.createShader(gl.FRAGMENT_SHADER);
                gl.shaderSource(fragmentShader, document.getElementById("shader-fs").textContent);
                gl.compileShader(fragmentShader);

                program = gl.createProgram();
                gl.attachShader(program, vertexShader);
                gl.attachShader(program, fragmentShader);
                gl.linkProgram(program);
                render();
            }          
            function getMousePos(canvas, evt){
                var rect = canvas.getBoundingClientRect();
                return {
                    x: evt.clientX - rect.left,
                    y: evt.clientY - rect.top
                };
            }
            function animation(){
                var posx = document.getElementById('xPoint').value;
                var posy = document.getElementById('yPoint').value;
                zoom/=1.01;
                offset = new Vector2f(posx, posy);
                render();
            }
            function render(){
                gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
                
                var vertices = new Float32Array([
                    -1, -1, 0,
                    -1, 1, 0,
                    1, -1, 0,
                    1, 1, 0,
                    -1, 1, 0,
                    1, -1, 0
                ]);
				
                var buffer = gl.createBuffer();
                gl.bindBuffer(gl.ARRAY_BUFFER, buffer);
                gl.bufferData(gl.ARRAY_BUFFER, vertices, gl.STATIC_DRAW);

                gl.useProgram(program);

                program.zoom = gl.getUniformLocation(program, 'zoom');
                gl.uniform1f(program.zoom, zoom);
                
                program.offset = gl.getUniformLocation(program, 'offset');
                gl.uniform2f(program.offset, offset.x, offset.y);

                program.position = gl.getAttribLocation(program, 'position');
                gl.enableVertexAttribArray(program.position);
                gl.vertexAttribPointer(program.position, 3, gl.FLOAT, false, 0, 0);
                
                gl.drawArrays(gl.TRIANGLES, 0, vertices.length/3);
            }
            function zoomMandel(){
                if(!animate)
                    animate = setInterval(animation,5);
                else{
                    window.clearInterval(animate);
                    animate = null;
                }
            }
            function reset(){
                if(animate){
                    window.clearInterval(animate);
                    animate = null;
                }
                zoom = 2;
                offset = new Vector2f(-1.5*zoom/2, -1.0*zoom/2);
                render();
            }
            var animate;
            function canvasClick(event){}
        </script>
    </head>
    <body onload = "webGLStart()">
        <canvas id="canvas" style="border: none; margin: 1em"
                width="800" height="800" onclick="canvasClick(event)"></canvas>
        <hr>
        <input id = "xPoint" type = "text" value = "0">
        <input id = "yPoint" type = "text" value = "0">
        <button type = "button" onclick="zoomMandel();">Zoom</button>
        <button type = "button" onclick="reset();">Reset</button>
		<hr>
		<p id = "coords"/>
    </body>
</html>
